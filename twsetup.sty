% Traditional Chinese article setup (XeLaTeX)
% Package: twsetup.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{twsetup}[2025/11/27 v1.0 TW article setup]

% Fonts and CJK
\RequirePackage{fontspec}
\RequirePackage{xeCJK}
% Improve CJK font behavior across platforms
\xeCJKsetup{AutoFakeBold=true, AutoFakeSlant=true, CJKmath=true}
\setmainfont{Times New Roman}
% CJK font selection with macOS-friendly fallbacks
\IfFontExistsTF{Noto Serif CJK TC}{\setCJKmainfont{Noto Serif CJK TC}}{%
  \IfFontExistsTF{PingFang TC}{\setCJKmainfont{PingFang TC}}{%
    \IfFontExistsTF{Songti TC}{\setCJKmainfont{Songti TC}}{%
      \IfFontExistsTF{Microsoft JhengHei}{\setCJKmainfont{Microsoft JhengHei}}{%
        \IfFontExistsTF{PMingLiU}{\setCJKmainfont{PMingLiU}}{%
          \IfFontExistsTF{MingLiU}{\setCJKmainfont{MingLiU}}{\setCJKmainfont{Hiragino Mincho ProN}}%
        }%
      }%
    }%
  }%
}
\IfFontExistsTF{Noto Sans CJK TC}{\setCJKsansfont{Noto Sans CJK TC}}{%
  \IfFontExistsTF{PingFang TC}{\setCJKsansfont{PingFang TC}}{%
    \IfFontExistsTF{Heiti TC}{\setCJKsansfont{Heiti TC}}{%
      \IfFontExistsTF{Microsoft JhengHei}{\setCJKsansfont{Microsoft JhengHei}}{\setCJKsansfont{Hiragino Sans}}%
    }%
  }%
}
% Use sans as monofont fallback for CJK glyphs
\IfFontExistsTF{Noto Sans Mono CJK TC}{\setCJKmonofont{Noto Sans Mono CJK TC}}{%
  \IfFontExistsTF{PingFang TC}{\setCJKmonofont{PingFang TC}}{\IfFontExistsTF{Microsoft JhengHei}{\setCJKmonofont{Microsoft JhengHei}}{\setCJKmonofont{Hiragino Sans}}}%
}
% Kai family: use DFKai-SB if available, else fallback to PingFang
\IfFontExistsTF{DFKai-SB}{\setCJKfamilyfont{kai}{DFKai-SB}}{\setCJKfamilyfont{kai}{PingFang TC}}
\newcommand{\kai}[1]{{\CJKfamily{kai}#1}}

% Layout & spacing
\RequirePackage[margin=2.5cm]{geometry}
\RequirePackage{setspace}
\setstretch{1.5}  % 1.5 line spacing for better readability

% Math
\RequirePackage{amsmath, amsfonts, amssymb}

% TikZ for diagrams
\RequirePackage{tikz}
\usetikzlibrary{shapes, arrows.meta, positioning}

% Section formatting and Chinese numerals
\RequirePackage{titlesec}
% Map section counter to Chinese numerals 一二三四五六七八九十
\newcommand{\CJKSectionNumber}[1]{%
  \ifcase#1\or 一\or 二\or 三\or 四\or 五\or 六\or 七\or 八\or 九\or 十\else #1\fi
}
% Map subsection counter to （一）...（十） then fallback
\newcommand{\CJKSubsectionNumber}[1]{%
  \ifcase#1\or （一）\or （二）\or （三）\or （四）\or （五）\or （六）\or （七）\or （八）\or （九）\or （十）\else (#1)\fi
}
% Title formats
\titleformat{\section}{\Large\bfseries}{\CJKSectionNumber{\value{section}}、}{0em}{}
\titleformat{\subsection}{\large\bfseries}{\CJKSubsectionNumber{\value{subsection}}}{0.5em}{}
\titleformat{\subsubsection}{\normalsize\bfseries}{\arabic{subsubsection}.}{0.5em}{}
% Spacing
\titlespacing*{\section}{0pt}{1.8ex plus .6ex}{1.0ex}
\titlespacing*{\subsection}{0pt}{1.2ex plus .4ex}{0.6ex}
\titlespacing*{\subsubsection}{0pt}{1.0ex plus .3ex}{0.4ex}

% Lists
\RequirePackage{enumitem}
\setlist{nosep}

% Tables
\RequirePackage{booktabs}
\RequirePackage{longtable}
\RequirePackage{array}
\RequirePackage{xcolor}
\RequirePackage{colortbl}
\definecolor{lightgray}{gray}{0.9}
% Default table spacing
\setlength{\tabcolsep}{6pt}
\renewcommand{\arraystretch}{1.25}
% Custom column types for centered content (vertical + horizontal)
\newcolumntype{C}[1]{>{\centering\arraybackslash}m{#1}}  % centered with fixed width
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}m{#1}}  % left-aligned with fixed width
% Caption spacing for tables
\RequirePackage{caption}
\captionsetup[table]{skip=10pt}

% Graphics
\RequirePackage{graphicx}
\graphicspath{{figures/}}

% Hyperref (keep minimal defaults; allow override in document)
\RequirePackage{hyperref}
\hypersetup{
  unicode=true,
  colorlinks=true,
  linkcolor=blue,
  urlcolor=blue,
  citecolor=blue,
  pdfborder={0 0 0}
}

% Bibliography with biblatex (numeric, grouped citations e.g., [3-5])
\RequirePackage[style=numeric-comp,sorting=none,backend=biber]{biblatex}
\addbibresource{references.bib}
